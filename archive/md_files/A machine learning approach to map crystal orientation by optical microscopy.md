## A machine learning approach to map crystal orientation by optical microscopy

Mallory Wittwer 1 and Matteo Seita 1,2 ✉

## Abstract

Mapping grain orientation in crystalline solids is essential to investigate the relationships between local microstructure and crystallography and interpret materials properties. One of the main techniques used to perform these studies is electron backscatter diffraction (EBSD). Due to the limited measurement throughput, however, EBSD is not suitable for characterizing samples with long-range microstructure heterogeneity, nor for building large material libraries that include numerous specimens. We present a machine learning approach for high-throughput crystal orientation mapping, which relies on the optical technique called directional re /uniFB02 ectance microscopy. We successfully apply our method on Inconel 718 specimens produced by additive manufacturing, which exhibit complex, spatially-varying microstructures. These results demonstrate that optical orientation mapping on a metal alloy is achievable. Since our method is data-driven, it can be easily extended to different alloy systems produced using different manufacturing processes.

## INTRODUCTION

Characterizing the microstructure of polycrystalline solids -including the size, morphology, and crystallographic orientation of the constituent crystal grains -is essential for understanding the relationships between process history, microstructure, and materials properties. This information enables predicting the behavior of structural and functional components and underpins the design of next-generation, high-performance materials 1 . The standard practice for crystallographic characterization involves diffraction-based methods, which rely on electron or X-ray microscopy techniques. One of the most utilized amongst these techniques is electron backscatter diffraction (EBSD). EBSD provides an accurate mapping of the material ' s constituent phases and grains as a function of their crystallographic orientation by measuring and indexing the local diffraction patterns produced by the atomic lattice as the electron beam is scanned across the sample surface 2,3 . Being tied to an electron microscope, however, EBSD is limited in terms of measurement throughput, /uniFB01 eld of view, and maximum specimen dimensions. Therefore, orientation imaging by EBSD is generally carried out on small-area specimens (of the order of mm 2 ), whose microstructure is representative of an entire component produced using a given manufacturing process. Due to these limitations, EBSD is inef /uniFB01 cient at building materials libraries that are based on numerous specimens produced using different process parameters 4 , or at characterizing samples that exhibit large-scale microstructure heterogeneity. These limitations are particularly detrimental in the context of metal additive manufacturing (AM). Indeed, the complex and variable solidi /uniFB01 cation pathways during fusion-based AM processes are known to yield microstructures that vary throughout the build and even across batches of nominally identical parts 1,5 . A high-throughput crystallographic characterization technique would signi /uniFB01 cantly accelerate the development of additive processes as well as their adoption by the industry 5 .

One possible solution is to employ optical microscopy techniques, which provide signi /uniFB01 cantly faster data acquisition and a larger /uniFB01 eld of view compared to EBSD. Since the atomic lattice cannot be resolved directly under visible light, however, optical orientation mapping may only be achieved indirectly, by analyzing optical signals that encode the underlying crystallographic orientation 6,7 . Based on this principle, techniques have been developed to quantify orientation-dependent changes in light intensity and polarization upon re /uniFB02 ection from optically active materials 8,9 , or to reconstruct the topography of etch-pits 10 , which inherit their geometry and orientation from the underlying atomic lattice. Directional re /uniFB02 ectance microscopy (DRM) falls in this second category 10,11 . The working principle of DRM is based on measuring and analyzing the re /uniFB02 ection of light from the surface of the material as a function of the illumination direction 10 -12 . When the material is chemically etched, the preferential dissolution of speci /uniFB01 c crystallographic planes 13 -15 or phases 16 can generate topographical surface features which are linked to crystallographic orientation. These features re /uniFB02 ect visible light preferentially at certain angles, producing a directional (i.e., anisotropic) re /uniFB02 ectance effect. Once captured by DRM, directional re /uniFB02 ectance data is analyzed by computational methods to enable spatial mapping of grain orientation 10,11 . Until now, however, orientation imaging by optical means has only been attained on pure crystalline solids, for which the measured optical signals could be indexed using material-speci /uniFB01 c, physics-based models. Expanding high-throughput optical orientation imaging to engineering metal alloys and other technologically relevant materials remains an open challenge, given that the complex, multi-phase microstructures of these materials give rise to optical signals that are dif /uniFB01 cult to decode using physics-based models.

Here, we present an optical method to perform grain orientation mapping in metal alloys. We use a convolutional neural network (CNN) to infer crystal orientation from the optical signal acquired by DRM. We name our model EulerNet because it predicts crystallographic orientation as represented by a set of Euler angles 17 . Our machine learning method circumvents some noteworthy limitations of physics-based approaches. Firstly, EulerNet learns the relationships between directional and crystal orientation autonomously, during training. That makes our work /uniFB02 ow easier and faster by reducing the need for human intervention. No specialized studies are needed to build up knowledge about the morphology and crystallography of the microstructural constituents responsible for directional re /uniFB02 ectance. Secondly, a machine learning model has the capacity of recognizing complex patterns in directional re /uniFB02 ectance signals, which may otherwise go unnoticed by human analysis, or which may be dif /uniFB01 cult to outline using conventional digital signal processing. Finally, our data-driven framework is /uniFB02 exible. It can be easily templated and applied to other alloys with different microstructures, making it possible to extend optical orientation imaging to a variety of materials. In the following sections, we describe our machine learning work /uniFB02 ow and demonstrate its effectiveness on Inconel 718 (I718) specimens produced by directed energy deposition (DED).

## RESULTS AND DISCUSSION

## Datasets, microstructure, and optical orientation maps

We produced a library of ten I718 specimens with rectangular geometry (24 mm × 24 mm × 12 -18 mm) by DED. During the DED process, raw material in powder form (in this case, I718) is continuously fed into a melt pool through a nozzle, melted by a high-power laser source, and solidi /uniFB01 ed upon cooling 18 . The material is deposited layer by layer on a build platform to create a three-dimensional shape. We produced our specimens using different combinations of laser powers, laser translating speeds, layer heights, and powder feed rates (Supplementary Table 1). These process parameters affect melt pool solidi /uniFB01 cation and the thermal history of the material 19,20 . As a result, different specimens exhibit different microstructures. Some specimens display highly textured, columnar dendritic grains of the face-centered cubic (FCC) γ matrix phase, which grows along the build direction (BD). In other specimens, we observe portions of /uniFB01 ner, randomly oriented grains interrupting the columnar growth, which produces a large-scale microstructure heterogeneity across the entire build. This heterogeneity is often found in DED-produced materials 21 . After deposition, we heat-treated the specimens following the ASTM standard for solutionizing and hardening I718 (see Methods). This heat treatment results in the formation of intermetallic precipitates in the microstructure, which are pivotal to our work. Among these precipitates, the orthorhombic phase δ (Ni3Nb) nucleates at the γ matrix grain boundaries and at dendrite boundaries through partial decomposition of the metastable, body-centered cubic (BCC) γ ″ (Ni3Nb) phase 22 . δ precipitates appear in the microstructure as elongated, plateletlike structures 22,23 .

To enable optical orientation mapping, we etched the specimens using a chemical reagent that selectively dissolves the γ matrix, letting the corrosion-resistant δ platelets protrude from the surface (Fig. 1a, bottom). Because they are tilted with respect to the XY plane, these precipitates produce a directional re /uniFB02 ectance signal which can be measured by DRM (Fig. 1a, top). Leveraging the crystallographic relationship between δ and γ , we use the directional re /uniFB02 ectance signal to assess the orientation of the γ matrix grains. Indeed, δ and γ are oriented such that (111) γ // (010) δ and [101] γ //[100] δ 22,24 . Moreover, the habit plane of δ precipitates (i.e., the predominant platelet facet plane) is aligned parallel to {111} γ 22 .

We took a DRM measurement of each specimen using the setup shown schematically in Fig. 1b and following the procedure detailed in reference 6 . The local directional re /uniFB02 ectance signal from any individual grain in the microstructure consists of the re /uniFB02 ection intensity measured at that grain as a function of the light source elevation ( θ ) and azimuth ( φ ) angles. Peaks in re /uniFB02 ection intensity may be observed at angles at which δ platelets re /uniFB02 ect the incoming light directly into the optical microscope. Because the orientation of the platelets depends on the crystallographic orientation of the corresponding γ grain, different grain orientations produce distinct re /uniFB02 ectance signals with different re /uniFB02 ectance peaks.

<!-- image -->

Fig. 1 Illustration of the DRM technique. a In I718, chemical etching reveals δ phase precipitates in the form of elongated platelets protruding on the surface (here, seen under the scanning electron microscope). These platelets are in a speci /uniFB01 c crystallographic relationship with the γ matrix, causing surface re /uniFB02 ectance to vary with grain orientation and the incident illumination angle. b The DRM apparatus (here, represented schematically) consists of a stereomicroscope focused on a /uniFB01 xed specimen and a moving white light source. A sequence of micrographs is captured while the light source rotates around the specimen.


Figure 2 illustrates the diversity of re /uniFB02 ectance patterns encountered in I718. In this /uniFB01 gure, we represent seven different crystal orientations in the inverse pole /uniFB01 gure (IPF) map along the Z-axis as octahedra. The facets in each octahedron lay parallel to the {111} γ planes of the underlying grains, which coincide with the habit planes of the δ precipitates 22 . In general, we observe that the number and position of re /uniFB02 ectance peaks in the re /uniFB02 ectance patterns follow the underlying crystal symmetry. For instance, the re /uniFB02 ectance pattern of the (100) γ grain contains four peaks separated by a 90° angle, which is consistent with the fourfold symmetry of the face-centered cubic (FCC) structure in this orientation. Similarly, the (110) γ grain pattern exhibits a two-fold symmetry. By contrast, we observe a six-fold symmetry in the pattern produced by (111) γ grains. The position of these re /uniFB02 ectance peaks qualitatively matches the coordinates at which we would expect to observe specular re /uniFB02 ections from {111} γ planes. This /uniFB01 nding is a strong indication that re /uniFB02 ectance peaks stem from specular re /uniFB02 ections of the incoming light at the protruding δ platelets.

Based on these observations, we speculate that grain orientation may be retrieved analytically, in principle, by devising a physics-based re /uniFB02 ection model that relates peaks position and intensity to the etch-induced surface topography and to the underlying crystal orientation. In practice, however, developing such a model is challenging, time-consuming, and relies heavily on the input of human experts. It requires sophisticated digital signal analysis to accurately identify the key directional re /uniFB02 ectance features in the optical signals, detailed characterization of the morphology, distribution, and crystallography of the microstructural constituents responsible for directional re /uniFB02 ectance, and an in-depth understanding of how these constituents interact with visible light to produce the directional re /uniFB02 ectance signal 10 .

<!-- image -->

Fig. 2 Directional re /uniFB02 ectance signals in I718. Directional re /uniFB02 ectance signals measured from differently oriented grains exhibit different re /uniFB02 ectance peaks. Each re /uniFB02 ectance pattern is connected to its corresponding crystallographic orientation along the Z-axis (i.e., the sample surface normal) in the inverse pole /uniFB01 gure (IPF) triangle. The peaks occur at illumination angles that coincide with specular re /uniFB02 ections from {111} γ crystallographic planes.

All these aspects make this approach dif /uniFB01 cult to template and hardly compatible with a high-throughput materials characterization paradigm.

By contrast, our machine learning model, EulerNet, can recognize complex patterns in directional re /uniFB02 ectance signals autonomously and predict orientation with high accuracy and throughput. As the relationships between the input and output are learned in a fundamentally unguided way during training, the model requires minimal human supervision. In particular, no specialized microstructural studies are required to build up prior knowledge of the linkage between surface topography, directional re /uniFB02 ectance, and crystal orientation. When used on a test specimen, EulerNet predicts a crystallographic orientation for each pixel in the DRM dataset, enabling grain orientation to be mapped spatially over the specimen ' s surface in a similar fashion as EBSD. Figure 3 compares the EulerNet and EBSD IPF grain maps (831 × 1102 pixels) from one of our I718 specimens. From visual inspection of these maps, it appears that the crystal orientation predictions by EulerNet based on DRM generally match the results obtained by EBSD. Acquiring a DRM measurement on our samples took about 20 min while generating the orientation maps using EulerNet took only a few minutes when running on a modern laptop computer. By contrast, acquiring the EBSD measurement took several hours. Furthermore, different instances of the EulerNet model can be trained on different material datasets. Therefore, the methodology can be easily templated and reapplied to different alloys, regardless of their microstructural complexity. All these characteristics make our machine learning approach suited to deliver high-throughput optical orientation imaging while minimizing development time and effort.

## Machine learning model

The CNN architecture of our EulerNet model is shown schematically in Fig. 4. CNNs are state-of-the-art machine vision algorithms that have proven effective at processing image-like data and have gained signi /uniFB01 cant attention in computer vision 25,26 . Our model takes as input a directional re /uniFB02 ectance signal in the form of a two-dimensional numerical array of 6 × 72 continuous values, which represent the local surface re /uniFB02 ection intensity across the array of illumination angles measured during DRM.

To predict crystal orientation from this input, the directional re /uniFB02 ectance signal is passed through two convolutional and maxpooling layers followed by two fully connected regression layers. The role of the convolutional and max-pooling layers is to extract visual patterns in the re /uniFB02 ectance signal which are informative about crystal orientation. In the /uniFB01 rst convolutional layer, simple visual patterns are detected. These so-called low-level features could be, for instance, edges and blobs. In the second convolutional layer, these patterns are assembled into more complex visual patterns representing, presumably, characteristics of the re /uniFB02 ectance peaks, such as their position, number, and intensity. These high-level features are then /uniFB02 attened (i.e., reduced to a single dimension) and further passed through the fully connected regression layers. The resulting output prediction takes the form of three continuous values: the Euler angles used to represent crystal orientation. Euler angles parameterize an ordered sequence of three rotations that bring the (right-handed) Cartesian coordinate system attached to the specimen onto that of the crystal.

The convolutional layers and the fully connected layers comprise several tunable parameters -such as weights and biases -that must be learned during a training phase. Training is performed iteratively by comparing model predictions to the ground truth, computing prediction error, and readjusting the trainable parameters through backpropagation to minimize the error and improve prediction accuracy 27 . Here, we use EBSD measurements as ground truth labels and design our EulerNet model to minimize the mean disorientation angle between the predicted crystal orientation and the ground truth. The disorientation angle represents the minimum angle of rotation about a given axis to bring the two crystal orientations into coincidence 28 . Once trained, we test the model on previously unseen specimens; namely data which we did not use for training. This approach is representative of a real application scenario, in which a newly produced part with an unknown microstructure must be characterized. To test our model, we apply cross-validation over ten splits to our set of specimens. We use data from nine specimens for training and hold one out for testing, switching the test specimen in-between each split. We further detail the process of selecting data for training and testing in the Methods section.

## Performance evaluation

We evaluate the performance of our EulerNet model by comparing the predicted and ground truth (EBSD) orientations at selected locations (i.e., pixels in the dataset) at the center of grains to avoid including data that might be misregistered in the test set (see Methods). For completion, we also include a comparative analysis on a pixel-level without /uniFB01 ltering the data in the supplementary materials (Supplementary Fig. 2). In Fig. 5a, we show the distribution of disorientation angles in the combined tests from all cross-validation splits. The median disorientation angle between the predicted and true orientations averaged across the ten cross-validation splits is 6.7° ± 0.8°. While this value is a useful performance indicator, we believe it overestimates the real error because of two existing and hardly avoidable limitations in our evaluation method. Firstly, registration of the EBSD and DRM datasets is challenging because of the substantial differences in spatial distortion resulting from the two types of measurement, which require nonlinear methods to bring the two /uniFB01 elds of view into coincidence. In this work, we employed an image registration algorithm based on optical estimation. We anticipate that, despite selecting pixels at the center of grains for the error evaluation, imperfections in the registration process may still lead to mislabeling of a fraction of the test data (see Supplementary Fig. 2c). The tail of the distribution at high disorientation angles in Fig. 5a likely contains this mislabeled data. Secondly, mounting the specimen for DRM such that the transverse and build directions are aligned parallel to the corresponding directions in the EBSD dataset is also a process that is subject to manual error, which is dif /uniFB01 cult to correct given the differences in spatial distortion between the two datasets.


<!-- image -->

Fig. 3 Orientation maps produced by EulerNet (DRM) and EBSD. The IPF maps produced by our EulerNet model from directional re /uniFB02 ectance are visually almost identical to the ground truth EBSD maps, both in-plane (along the X and Y reference directions) and out-of-plane (along the Z direction). The specimen shown in the /uniFB01 gure was not used for training the model. The scale bar represents 5 mm.

<!-- image -->

Fig. 4 Convolutional neural network model architecture. Our CNN model, EulerNet, connects the input directional re /uniFB02 ectance signal to crystal orientation, which is represented as a set of three Euler angles. The input is /uniFB01 rst passed through convolutional layers and max-pooling layers to extract visual patterns, and then through fully connected regression layers, leading to the Euler angles prediction.

<!-- image -->


We also examine the orientation dependence of the prediction error by evaluating it along each of the specimen ' s reference directions. To evaluate the error along these axes, we consider the two 3 × 3 rotation matrices associated with the Euler angles predicted by EulerNet, g 1, and the EBSD measurement, g 2. We compute e X, e Y, and e Z, which represent the angles between the predicted and true normal vectors of the plane facing the specimen ' s reference directions, as:

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

We compute the mean values of e X, e Y, and e Z, in the test set and name these metrics D X, D Y, and D Z. The values of D X, D Y, and D Z, averaged across all cross-validation splits, are respectively 6.5° ± 0.6°, 6.4° ± 0.6° and 5.8° ± 0.6°. This result indicates a slightly lower prediction error along the out-of-plane direction ( D Z) compared to the in-plane directions ( D X, D Y). This difference may come from the greater potential for misalignment of the specimens in-plane compared to out-of-plane when mounting them to carry out DRM measurements. Finally, in Fig. 5b, we plot the disorientation angle as a function of crystal orientation in the principal axes of the specimen ' s coordinate system. The error distribution is mostly uniform, except for the slight increase near the {111} γ orientation in the out-of-plane direction (Z). We believe that this minor inhomogeneity could be related to the peculiar six-fold symmetry seen in the directional re /uniFB02 ectance signal corresponding to this crystal orientation (Fig. 2).

Fig. 5 Evaluation of EulerNet performance. a The disorientation angle between the predicted orientation and the EBSD ground truth is centered around 5-8°. b The disorientation angle is marginally higher in the vicinity of the {111} γ orientation out-of-plane (Z) and is otherwise mostly uniform across the other orientations.

<!-- image -->

Our EulerNet model provides reliable orientation mapping in all our I718 specimens (Supplementary Fig. 1) despite the marked differences in their microstructure, which stem from the different DED parameters we used to produce them. This result suggests that EulerNet is robust to variations induced by the manufacturing process and can be used to characterize a wide range of I718 microstructures. Nevertheless, we note that our reported accuracy of 6.7° -even though overestimated by dataset misregistration -is substantially higher than the typical accuracy attainable by EBSD (~0.6°) 17 . We speculate that the error rate of our optical technique may also be affected by the inherent tolerance found in the elements that make DRM, including the level of light collimation, the quality of the optical lens of the camera, the accuracy of the motors which move the light source around the specimen, and the variability of the etch-induced surface structures. Thus, it is likely that increasing equipment accuracy would enhance the measurement accuracy signi /uniFB01 cantly. In addition, given the vast design space of neural networks and the rapid developments in this /uniFB01 eld, it is possible that future improvements in the design or in the implementation of our CNN model could further contribute to improve performance.

Finally, we believe that DRM should not be considered as a direct substitute for EBSD, which remains the main technique for detailed analysis of crystallographic features, especially at the small scale. Instead, we believe that DRM combined with our machine learning technique can be an invaluable tool in supporting materials development efforts that require the application of orientation mapping to large specimens or vast databases. It may also be particularly suitable for applications that tolerate a modest trade-off in accuracy for a considerably increased measurement throughput. Many of such applications already exist. A notable example is the identi /uniFB01 cation of relationships between crystallographic texture, process parameters, and part geometry in metal AM.

## Handling anomalous data

Once an EulerNet is trained and validated, it becomes permanently available for future characterization of a speci /uniFB01 c material. The model used in this study, for instance, is available online (see Data Availability) and is suitable for the characterization of I718 specimens produced by DED. We believe that our model would yield reliable results on any such specimen as long as the δ phase precipitates -which generate the directional re /uniFB02 ectance signal -are well-developed in the alloy and visible after etching. These conditions should be met when carrying out ASTM standard heat treatments on I718 and when the specimen surface preparation (including polishing and chemical etching) is performed following the same steps as those used to prepare the training dataset. We note that using DRM apparatuses that consist of equipment different from that used to produce the training set (e.g., the optical microscope, the camera sensor, the light source, etc.) could potentially introduce systematic bias into the data and affect the error rate. To minimize equipment bias and ensure model transferability across the community, we advise for equipment calibration, which we detail in the Methods section. If systematic equipment bias persisted despite the calibration, we foresee that applying transfer learning 29,30 to /uniFB01 ne-tune neural networks to a speci /uniFB01 c set of hardware might be a suitable solution to explore.

Regardless of its origins, it is important to be able to detect and exclude biased data to prevent fundamentally wrong microstructure characterization output. Indeed, machine learning models make predictions without any judgment on the quality of the input data or without any capacity to assess the uncertainty associated with the predictions 31 . If a test specimen is markedly different from the training specimens -which may occur, for example, as a result of failed specimen preparation, or when using a new DRM apparatus -the input data may be out-of-distribution (i.e., unrepresentative) and the associated predictions by the machine learning model may be /uniFB02 awed 32 . To detect out-ofdistribution data, we propose an anomaly detection model based on dimensionality reduction of the DRM dataset by principal component analysis (PCA) 33 . We compute the two /uniFB01 rst principal components of the directional re /uniFB02 ectance signals in the training set and project the data in this manifold. By construction, PCA components represent axes along which variance in the data is maximized. Along the PCA axes, training data is scattered following a distribution close to normal. We standardize these distributions by centering them around 0, with a standard deviation of 1, to ensure that they are in the same relative range. Then, we de /uniFB01 ne the average of both variables as a single out-ofdistribution indicator, z . This indicator is unitless. It re /uniFB02 ects how far the data is from the mean of the training set distribution.

This z -score model is both simple to implement and ef /uniFB01 cient in detecting biased data. We illustrate its effectiveness by comparing two separate I718 specimens produced by DED. The /uniFB01 rst one (in Fig. 6a) is a specimen whose microstructure contains a few lack-offusion defects (see Fig. 6c) resulting from an excessive layer height setting during the DED process. The other (in Fig. 6d) is a specimen that, despite being heat-treated and etched according to standards, shows underdeveloped crystallographic surface features, and even a complete absence of them (see Fig. 6f) in the region near the baseplate. This anomaly is due to the variable cooling rates established within the alloy during processing, which led to high Nb retention in solid solution (and, correspondingly, depletion of δ phase precipitates) in the /uniFB01 rst portion of the build 34 . The corresponding z-maps successfully identify both anomalies. In the specimen in Fig. 6a, the distribution of the z value (in Fig. 6b) approximately follows that of the training dataset, indicating that directional re /uniFB02 ectance in this specimen and in the training set are globally alike. However, lack-of-fusion defects get highlighted by the anomaly detection model. The uniformly bright appearance of the lack-of-fusion defects in the bright/uniFB01 eld optical micrograph in Fig. 6c suggests that the surface remained locally /uniFB02 at (i.e., mirror-like) and that it did not react to the chemical etchant. In the specimen in Fig. 6d, it is apparent that z is generally higher compared to the training set (see Fig. 6e), and increases progressively towards the bottom of the sample, where there are no δ phase precipitates.

<!-- image -->

Fig. 6 Detection of anomalies and systematic bias in DRM datasets. Applying anomaly detection to new directional re /uniFB02 ectance datasets enables to preemptively detect and discard unrepresentative data, which is not suitable for orientation imaging by the EulerNet model. a Anomaly detection in a regular specimen containing lack-of-fusion defects. When mapping z across the surface, the defects get highlighted by the anomaly detection model. b The distribution of z in this specimen is otherwise close to that of the training set distribution. c An example of lack-of-fusion defect seen under the optical microscope. d In a specimen with underdeveloped or absent δ phase precipitates exhibiting a globally high z -score. e The distribution of z is shifted compared to that of the training set. f Under SEM, no δ phase precipitates are visible on the specimen ' s surface in the area close to the baseplate. The scale bars in ( a , d ) represent 5 mm and the scale bar in ( f ) represents 5 µm.

These examples illustrate that applying anomaly detection to new specimens of interest can be effective at detecting unrepresentative data, enabling preemptively verifying its suitability for orientation imaging by the EulerNet model. As the meaning of a high z -score can vary, the /uniFB01 nal decision to keep or discard data based on this indicator should be left to the operator based on his/her domain expertise and interpretation of the data.

## Future outlook

Our results underpin the tremendous potential of machine learning algorithms for the automated decoding of directional re /uniFB02 ectance signals and their application to crystallographic orientation mapping. In this paper, we decided to focus on Inconel 718 owing to the technological relevance of this alloy, which is used for many components in aircraft, rocket engines, turbines, and combustion chambers. In principle, however, our method would be applicable to any other alloy for which a reliable crystallographic etching method can be identi /uniFB01 ed. Fortunately, the identi /uniFB01 cation of etchants that are amenable to producing crystallographic features on the specimen surface is facilitated by the large body of literature produced by metallographers, who have perfected the chemical etching of metals and metal alloys over the past several decades 14 .

Once a suitable etchant is identi /uniFB01 ed for a given material, our machine learning approach can be applied without the need for detailed microstructural studies or for deriving and manually tuning a physics-based orientation indexing model. The only requirement is to gather an initial set of specimens of the material to be characterized, assess their microstructure by means of DRM and EBSD, and train and validate the corresponding EulerNet model. Because of the relatively high cost of initially gathering data to perform training, validation, and optimization of a new model, there is great bene /uniFB01 t in sharing trained models across the materials science community at large for a variety of different materials, alongside detailed information about surface preparation of the specimens, DRM equipment used (and the corresponding calibration), and the attainable performance. This endeavor could be achieved, for example, through e-collaborations.

The low cost and availability of the equipment required to carry out DRM measurements hold the promise to spread optical orientation mapping capabilities across both academia and the industry. We believe that our method would /uniFB01 nd immediate application in the research and development of metal AM processes, where there is high interest in expanding orientation imaging to entire, large-scale components. Moreover, our machine learning approach is the /uniFB01 rst to demonstrate orientation imaging of a complex alloy by optical means. As such, it could be pivotal in establishing a solid foundation for highthroughput optical orientation microscopy, leading to faster discovery of process-structure-property relationships and accelerated materials discovery.

## METHODS

## Datasets

The nominal composition of the I718 specimens was 54% Ni, 18% Cr, 20% Fe, 5% Mo, 2% Nb, and 1% Ti. We produced them using a commercialdirected energy deposition machine (by BeAM) equipped with a 24Vx nozzle. We set the hatch spacing to 1.5 mm with 33% overlap, the working distance to 13 mm, and the central and secondary gas /uniFB02 ow rates to 6 and 10 L/min. After deposition, we heat-treated the I718 specimens in a vacuum furnace using a three-stage process including a 60-min hold at 950 °C, an 8-h hold at 750 °C (for age hardening), and another 8-h hold at 690 °C (following standard AMS5663 for I718). We cut the heat-treated specimens along the XY plane perpendicular to the build direction (Z), and mechanically ground them according to standard metallographic sample preparation techniques to reveal the microstructure. To grind the specimens, we used a sequence of silicon carbide paper from 320 grit to 4000 grit. We then polished them to a mirror-like /uniFB01 nish using a colloidal suspension of silica particles. Finally, we etched the specimens by immersion in a bath of Kalling ' s 2 reagent (5 g cupric chloride, 100 mL hydrochloric acid, and 100 mL ethanol) at room temperature for 10 min.

For all specimens, we measured crystal orientation by EBSD and registered the EBSD and DRM /uniFB01 elds of view so that each re /uniFB02 ectance pattern could be associated to a reference orientation, which we regard as a ground truth. We performed EBSD measurements in a JEOL 7600 F /uniFB01 eld emission scanning electron microscope equipped with an Oxford instruments Nordlys 2 S EBSD detector. We used a 15 mA emission current, 20 kV accelerating voltage, and a 15 μ m step size. To perform DRM measurements, we used an apparatus consisting of an Olympus SZ6145 stereomicroscope equipped with a 3X objective lens, an industrial monochrome CMOS camera, and a white LED light source. We varied the light source elevation angle ( θ ) from 15° to 65° in steps of 10° and the azimuth angle ( φ ) from 0° to 355° in steps of 5° and captured an image for each ( θ , φ ) combination. As a result, each DRM dataset contained a stack of 6 × 72 = 432 images. The original resolution of the images captured was 2448 × 2048 pixels. The images were downscaled to 1224 × 1024 pixels in the DRM datasets to reduce memory transfer during data processing. We normalized the measured re /uniFB02 ectance against a uniform white re /uniFB02 ector 6 to compensate for uneven light intensity. We registered the DRM and EBSD datasets using the Python Scikit-image implementation of the TV-L1 solver for coarse to /uniFB01 ne optical /uniFB02 ow estimation 35 .

## Model implementation

We implemented our EulerNet model in the Python Tensor /uniFB02 ow library 36 using the Keras Functional API 37 . In Table 1, we report the speci /uniFB01 cations of all constitutive layers. Our model leveraged a total of 1 ' 219 ' 523 trainable parameters.

## Objective function

The aim of our EulerNet model was to minimize the disorientation angle between the predicted output and the ground truth EBSD orientation 28 . In face-centered cubic (FCC) crystal structures (the structure of the γ phase in I718), 24 different symmetry operations can be applied to the crystal and result in equivalent orientations. Owing to this crystal symmetry, the

| Table 1. EulerNet model layer speci /uniFB01 cations.                                      | Table 1. EulerNet model layer speci /uniFB01 cations.                                                                                                                                                                                         |
|--------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Layer type                                                                                 | Speci /uniFB01 cations                                                                                                                                                                                                                        |
| Convolutional (2D) Pooling (2D) Convolutional (2D) Pooling (2D) Flatten Dense Dense Output | (Kernel: 3 × 3; 64 /uniFB01 lters, stride: 1×1, ReLU) (Pool size: 2 × 2; stride: 1 × 1) (Kernel: 3 × 3; 64 /uniFB01 lters, stride: 1×1, ReLU) (Pool size: 2 × 2; stride: 1 × 1) (Size: 1 ′ 152) (Size: 784, ReLU) (Size: 384, ReLU) (Size: 3) |

<!-- image -->

8

disorientation angle is derived as the minimum among the 24 different angles computed between the ground truth and all orientations equivalent to the predicted orientation. Considering two 3 × 3 rotation matrices g 1 and g 2, associated with the Euler angles of the predicted and ground truth orientations, respectively, and Si = 1:24 the ensemble of the 24 symmetry operators for the FCC crystal structure, the disorientation angle is given by:

<!-- formula-not-decoded -->

During training, the input data was passed into the model iteratively in mini-batches of 50 examples. At each mini-batch iteration, the weights and biases of the fully connected components and the /uniFB01 lters of the convolutional layers were progressively updated by backpropagating the error given by the objective function 28 using an optimizer algorithm. As an optimizer, we used the Adam algorithm 38 which requires the objective function to be differentiable with respect to its inputs to enable computation of the gradients. This is not the case of the disorientation expression above because the arccos( x ) function is only de /uniFB01 ned in the domain of [ -1, 1], which induces discontinuities in the gradient of the disorientation metric with respect to the input orientations. Therefore, this expression cannot be used directly as an objective function 17 . Instead, we implemented an approximation to the disorientation function as:

<!-- formula-not-decoded -->

This function takes as input two rotation matrices de /uniFB01 ning the orientations and returns a value approximating the disorientation angle in the vicinity of tr ( x ) = 3, which corresponds to small disorientations. The function otherwise monotonically decreases with tr ( x ), thus following the disorientation function. These properties make it a suitable choice of objective function because its minimization conjointly minimizes the disorientation function while it is also differentiable with respect to the input orientations.

## Training

For all specimens, we registered the DRM and EBSD /uniFB01 elds of view so that each re /uniFB02 ectance pattern could be associated to the corresponding reference orientation. Instead of using all the pixels in the datasets for training and evaluating the models -which would be inef /uniFB01 cient due to the redundancy of pixels belonging to the same grain -we selected a single re /uniFB02 ectance pattern and its associated orientation from each grain to form both training and test sets. We /uniFB01 rst segmented the microstructures into grains using the LRC-MRM algorithm detailed in reference 39 . Then, we excluded grains smaller than six pixels in diameter, for which registration between the DRM and EBSD datasets might be inaccurate. In all remaining grains, we selected the pixel furthest from any grain boundaries as a training data point, based on the maximum of the Euclidean distance transform of the grain 40 . Following this strategy, we included on average 68 ' 850 data points for training. The size of the training set varied slightly depending on the cross-validation split. Moreover, we used data augmentation to increase the variety of the training data, which can reduce potential over /uniFB01 tting 41 . We augmented the training set by randomly rotating of the re /uniFB02 ectance signals around the azimuth and multiplying the re /uniFB02 ectance signals by a random factor sampled from a normal distribution, with an average of 1 and a standard deviation of 0.2 (we clipped the resulting values in the range 0 -1). We performed these augmentations based on the assumption that the model should be able to recover the correct crystal orientation regardless of the origin of the azimuth and of variations in re /uniFB02 ection intensity, as neither alteration is expected to change the structure of the re /uniFB02 ectance patterns.

We trained the neural network for 100 epochs (an epoch corresponds to one full cycle through the training dataset) starting from a random initialization of the trainable parameters. We tuned the learning rate by searching over a logarithmic grid of values between 10 -6 and 10 -2 . We found that the value leading to the lowest error was 3.1 × 10 -3 . With these parameters, it took 1 h and 32 min to train the EulerNet model on a commercial laptop computer equipped with an Intel i7-9750 CPU.

## DATA AVAILABILITY

The data required to reproduce these /uniFB01 ndings are available to download from https://data.mendeley.com/datasets/z8bh7n5b7d/1.
